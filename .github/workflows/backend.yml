name: Backend CI/CD

on:
  push:
    branches: [ main, master ]
    paths: [ 'backend/**' ]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.9'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: 🔄 Checkout
      uses: actions/checkout@v4

    - name: 🐍 Setup Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: 📦 Install dependencies
      run: |
        cd backend/api
        pip install --upgrade pip
        pip install -r requirements.txt

    - name: 🧪 Validate code
      run: |
        cd backend/api
        python -m py_compile function_app.py
        echo "✅ Python syntax valid"
        
        # Check required imports
        grep -q "azure.functions" function_app.py && echo "✅ Azure Functions imports found" || exit 1
        grep -q "azure.data.tables" function_app.py && echo "✅ Table Storage imports found" || exit 1

    - name: 🔒 Security check
      run: |
        cd backend/api
        if grep -r "password\|secret.*=" --include="*.py" . | grep -v "os.environ\|getenv"; then
          echo "❌ Hardcoded secrets found"
          exit 1
        fi
        echo "✅ No hardcoded secrets"

    - name: 📦 Create package
      run: |
        cd backend
        zip -r function-app.zip api/ -x "api/__pycache__/*" "api/*.pyc"
        echo "✅ Package created: $(du -h function-app.zip | cut -f1)"

    - name: 🚀 Deployment Status
      run: |
        echo "✅ Backend validation completed"
        echo "📦 Ready for Azure Functions deployment"
        echo "🔗 Target: func-resume-1760986821"
        echo "🔗 API: https://func-resume-1760986821.azurewebsites.net/api/visitor-counter"
        echo ""
        echo "💡 To deploy: Add AZURE_CREDENTIALS to GitHub Secrets"
