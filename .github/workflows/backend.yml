name: Backend CI/CD

on:
  push:
    branches: [ main, master ]
    paths: [ 'backend/**' ]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Validate structure
      run: |
        echo "Validating project structure..."
        
        if [ ! -d "backend" ]; then
          echo "ERROR: backend/ directory not found"
          exit 1
        fi
        
        if [ ! -d "backend/api" ]; then
          echo "ERROR: backend/api/ directory not found"
          exit 1
        fi
        
        if [ ! -f "backend/api/function_app.py" ]; then
          echo "ERROR: function_app.py not found"
          exit 1
        fi
        
        if [ ! -f "backend/api/requirements.txt" ]; then
          echo "ERROR: requirements.txt not found"
          exit 1
        fi
        
        echo "SUCCESS: Project structure validated"

    - name: Setup Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: |
        cd backend/api
        echo "Installing Python dependencies..."
        pip install --upgrade pip
        
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
          echo "SUCCESS: Dependencies installed successfully"
        else
          echo "ERROR: requirements.txt not found"
          exit 1
        fi

    - name: Validate code
      run: |
        cd backend/api
        python -m py_compile function_app.py
        echo "SUCCESS: Python syntax valid"
        
        # Check required imports
        if grep -q "azure.functions" function_app.py; then
          echo "SUCCESS: Azure Functions imports found"
        else
          echo "ERROR: Azure Functions imports missing"
          exit 1
        fi
        
        if grep -q "azure.data.tables" function_app.py; then
          echo "SUCCESS: Table Storage imports found"
        else
          echo "ERROR: Table Storage imports missing"
          exit 1
        fi

    - name: Create deployment package
      run: |
        cd backend/api
        echo "Creating deployment package..."
        
        # Create clean deployment directory
        mkdir -p deploy
        
        # Copy essential files
        cp function_app.py deploy/
        cp requirements.txt deploy/
        cp host.json deploy/
        
        # Create zip package
        cd deploy
        zip -r ../function-deploy.zip .
        cd ..
        
        echo "SUCCESS: Deployment package created"
        ls -la function-deploy.zip

    - name: Azure Login (Fallback Authentication)
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
      continue-on-error: true

    - name: Deploy to Azure Functions
      env:
        AZURE_FUNCTIONAPP_PUBLISH_PROFILE: ${{ secrets.AZURE_FUNCTIONAPP_PUBLISH_PROFILE }}
      run: |
        cd backend/api
        
        echo "📦 Deploying to Azure Functions..."
        
        # Check if publish profile is available
        if [ -n "$AZURE_FUNCTIONAPP_PUBLISH_PROFILE" ]; then
          echo "✅ Using publish profile deployment method..."
          
          # Save publish profile to temporary file
          echo "$AZURE_FUNCTIONAPP_PUBLISH_PROFILE" > publish-profile.xml
          
          # Install Azure Functions Core Tools if not available
          if ! command -v func &> /dev/null; then
            echo "Installing Azure Functions Core Tools..."
            npm install -g azure-functions-core-tools@4 --unsafe-perm true
          fi
          
          # Deploy using Azure Functions Core Tools
          func azure functionapp publish func-resume-1760986821 --publish-profile publish-profile.xml --python
          
          # Clean up
          rm -f publish-profile.xml
          
        else
          echo "⚠️ Publish profile not available, using Azure CLI deployment..."
          
          # Create deployment package
          echo "Creating deployment package..."
          mkdir -p deploy
          cp function_app.py deploy/
          cp requirements.txt deploy/
          
          # Create basic host.json
          echo '{"version":"2.0","functionTimeout":"00:05:00","extensionBundle":{"id":"Microsoft.Azure.Functions.ExtensionBundle","version":"[3.*,4.0.0)"}}' > deploy/host.json
          
          # Create zip package
          cd deploy
          zip -r ../function-deploy.zip .
          cd ..
          
          # Deploy using Azure CLI
          az functionapp deployment source config-zip \
            --resource-group rg-cloud-resume \
            --name func-resume-1760986821 \
            --src function-deploy.zip
          
          # Clean up
          rm -rf deploy function-deploy.zip
        fi
        
        echo "✅ Backend deployment completed successfully"

    - name: Deployment Status
      run: |
        echo "SUCCESS: Backend deployed to Azure Functions"
        echo "INFO: Function App: func-resume-1760986821"
        echo "INFO: API URL: https://func-resume-1760986821.azurewebsites.net/api/get-visitor-count"
        echo "INFO: Health Check: https://func-resume-1760986821.azurewebsites.net/api/health"